<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Boketto – Dashboard Embed</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <!-- ECharts para o gráfico de Collections -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" defer></script>
  <style>
    :root{
      --accent:#8B5CF6;
      --text:#111827;
      --muted:#6b7280;
      --card:#ffffff; /* os cards têm fundo branco, mas a página é transparente */
      --border:rgba(0,0,0,.06);
      --shadow:0 8px 20px rgba(0,0,0,.05);
      --radius:14px;
    }

    /* fundo transparente p/ embutir no Noloco */
    html,body{margin:0;padding:0;background:transparent;font-family:Inter,system-ui,-apple-system,sans-serif;color:var(--text);}

    .container{
      width:100%;
      box-sizing:border-box;
      padding:6px 6px 16px; /* leve respiro dentro do iframe */
    }

    /* GRID DOS CARDS */
    .cards{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
      margin-bottom:18px;
    }
    /* Tablet: 2 colunas */
    @media (min-width:768px) and (max-width:1023px){ .cards{ grid-template-columns: repeat(2, 1fr);} }
    /* Mobile: 1 coluna */
    @media (max-width:767px){ .cards{ grid-template-columns: 1fr; gap:12px; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:18px 20px;
    }
    .kpi-title{font-size:.95rem;color:var(--muted);margin:0 0 8px;}
    .kpi-value{font-size:1.6rem;font-weight:700;margin:0 0 6px;}
    .kpi-sub{font-size:.85rem;color:#10b981;margin:0;} /* verdinho “up” */

    /* SALES TREND */
    .chart-card{
      background:transparent; /* bloco do gráfico mantém transparência */
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:5px;
      margin-bottom:18px;
    }
    .chart-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:30px;
      padding:20px 30px 0 30px; /* padding pedido p/ título + subtítulo */
    }
    .title{font-size:1.1rem;font-weight:600;margin:0;}
    .subtitle{font-size:.85rem;color:var(--muted);margin-top:4px;}
    .controls{display:flex;gap:8px;align-items:center}
    .pill{border:none;border-radius:8px;padding:6px 12px;font-size:.85rem;cursor:pointer;background:#f3f4f6;color:#111827;transition:.15s}
    .pill:hover{background:#e5e7eb}
    .pill.active{background:var(--accent);color:#fff}
    #refreshBtn{border:none;border-radius:8px;padding:6px 12px;font-size:.85rem;background:#f3f4f6;color:#111827}
    #refreshBtn:hover{background:#e5e7eb}
    /* Gráfico ocupa o contêiner para manter proporção responsiva */
    #salesChart{width:100%!important;height:100%!important;display:block}

    /* Altura fixa apenas para o ranking (barras). */
    #productRankingChart{width:100%!important;height:320px!important;display:block}

    /* Gráfico de pizza com proporções melhoradas */
    .collection-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 320px;
      padding: 0 20px;
      gap: 12px;
    }
    .chart-container {
      width: 100%; /* ocupa todo o painel ao usar legenda interna do ECharts */
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* legenda externa não é mais usada */
    .legend-container { display: none; }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px;
      width: 45%;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin-right: 5px;
    }
    #collectionChart {
      width: 100%;
      height: 100%; /* ECharts precisa de altura definida */
      margin: 0 auto;
      display: block;
    }

    .loading,.empty,.error{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      color:var(--muted);font-size:.95rem;text-align:center;padding:16px
    }
    .hidden{display:none!important}
    .chart-wrap{
      width:100%;
      height:380px;
      position:relative;
      box-sizing:border-box;
    }

    /* LINHA INFERIOR */
    .bottom{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width:767px){ .bottom{ grid-template-columns: 1fr; } }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:20px 22px;
    }
    .panel h3{margin:0 0 10px;font-size:1.02rem}
    .panel p.muted{margin:0 0 14px;color:var(--muted);font-size:.9rem}

    /* --- MOBILE --- */
    @media (max-width: 767px) {
      html, body { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
      .container { min-height: 100vh; overflow-x: hidden; }

      /* Tipografia e espaçamento */
      .kpi-title{ font-size:.9rem; }
      .kpi-value{ font-size:1.4rem; }
      .kpi-sub{ font-size:.8rem; }
      .panel{ padding:16px 16px; }

      /* Header do gráfico */
      .chart-header{
        margin-bottom:16px;
        padding:14px 14px 0 14px;
      }
      .title{ font-size:1rem; }
      .subtitle{ font-size:.8rem; }

      /* Controles de toque maiores e acessíveis */
      .controls{ gap:6px; flex-wrap:wrap; }
      .pill, #refreshBtn{
        min-height:40px;
        padding:10px 14px;
        font-size:.95rem;
        touch-action: manipulation;
      }
      .pill:focus-visible, #refreshBtn:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }

      /* Alturas dos gráficos */
      .chart-wrap{ height:260px; }
      #productRankingChart{ height:260px!important; }

      /* Grid inferior em coluna */
      .collection-container{ flex-direction: column; height:auto; padding: 0 12px; }
      .chart-container{ width:100%; height:auto; }
      .legend-container{ width:100%; }
      .legend-item{ width:100%; }
      #collectionChart{ width:100%; height:260px; } /* altura explícita para ECharts em mobile */
    }

    /* --- MOBILE PEQUENO --- */
    @media (max-width: 480px) {
      .chart-wrap{ height:230px; }
      #productRankingChart{ height:230px!important; }
      .cards{ gap:12px; }
      .panel{ padding:14px; }
    }

    /* --- LANDSCAPE EM MOBILE --- */
    @media (orientation: landscape) and (max-width: 767px) {
      .chart-wrap{ height:220px; }
      #productRankingChart{ height:220px!important; }
    }
    
    /* --- TABLET (768px–1023px) --- */
    @media (min-width: 768px) and (max-width: 1023px) {
      .chart-header{ margin-bottom:24px; padding:18px 22px 0 22px; }
      .title{ font-size:1.1rem; }
      .subtitle{ font-size:.9rem; }
      .panel{ padding:18px 20px; }
      .panel h3{ font-size:1.05rem; }
      .panel p.muted{ font-size:.9rem; }
      .chart-wrap{ height:320px; }
      #productRankingChart{ height:300px!important; }
      .collection-container{ height:320px; }
      .bottom{ grid-template-columns: 1fr; gap:16px; }
    }

    /* --- DESKTOP (>=1024px) --- */
    @media (min-width: 1024px) {
      .cards{ grid-template-columns: repeat(4, 1fr); gap:20px; }
      .chart-header{ margin-bottom:36px; padding:24px 36px 0 36px; }
      .title{ font-size:1.2rem; }
      .subtitle{ font-size:.95rem; }
      .panel{ padding:24px 26px; }
      .panel h3{ font-size:1.1rem; }
    .panel p.muted{ font-size:.95rem; }
    .chart-wrap{ height:420px; }
    #productRankingChart{ height:340px!important; }
    .collection-container{ height:360px; }
    .bottom{ gap:20px; }
  }
  /* KPI details and delta colors */
  .kpi-secondary{ margin-top:6px; font-size:.85rem; color:#9ca3af; line-height:1.35; }
  .delta-up{ color:#22c55e; }
  .delta-down{ color:#f87171; }
  .delta-flat{ color:#9ca3af; }
  </style>
</head>
<body>
  <div class="container">

    <!-- 4 CARDS SUPERIORES (estáticos) -->
    <section class="cards">
      <div class="card">
        <p class="kpi-title">Total Sales</p>
        <p class="kpi-value" id="kpi-total">R$ 2.300,00</p>
        <p class="kpi-value" id="kpi-total-sales-value" style="display:none"></p>
        <p class="kpi-sub" id="kpi-total-sub">↑ 11 orders in period</p>
        <div class="kpi-secondary" id="kpi-total-sales-details"></div>
      </div>
      <div class="card">
        <p class="kpi-title">Average Order Value</p>
        <p class="kpi-value" id="kpi-aov">R$ 209,09</p>
        <p class="kpi-value" id="kpi-aov-value" style="display:none"></p>
        <p class="kpi-sub" id="kpi-aov-sub">↑ Based on 11 transactions</p>
        <div class="kpi-secondary" id="kpi-aov-details"></div>
      </div>
      <div class="card">
        <p class="kpi-title">Number of Transactions</p>
        <p class="kpi-value" id="kpi-transactions">11</p>
        <p class="kpi-value" id="kpi-tx-orders" style="display:none"></p>
        <p class="kpi-sub" id="kpi-transactions-sub">↑ From 2025-09-15 to 2025-10-15</p>
        <div class="kpi-secondary" id="kpi-tx-details"></div>
      </div>
      <div class="card">
        <p class="kpi-title">Gross Margin</p>
        <p class="kpi-value" id="kpi-margin">100.0%</p>
        <p class="kpi-value" id="kpi-gm-value" style="display:none"></p>
        <p class="kpi-sub" style="color:#9ca3af">No COGS data available</p>
        <div class="kpi-secondary" id="kpi-gm-details"></div>
      </div>
    </section>

    <!-- SALES TREND (API REAL) -->
    <section class="chart-card">
      <div class="chart-header">
        <div>
          <div class="title">Sales Trend</div>
          <div class="subtitle" id="subtitle">Sales evolution over the last 30 days</div>
        </div>
        <div class="controls" id="salesControls">
          <button class="pill" data-days="7" aria-label="Últimos 7 dias">7d</button>
          <button class="pill active" data-days="30" aria-label="Últimos 30 dias">30d</button>
          <button class="pill" data-days="90" aria-label="Últimos 90 dias">90d</button>
          <button id="refreshBtn" aria-label="Atualizar gráfico">↻ Refresh</button>
        </div>
      </div>

      <div class="chart-wrap">
        <canvas id="salesChart" aria-label="Vendas diárias" role="img"></canvas>
        <div class="loading" id="loading" role="status" aria-live="polite">Loading data...</div>
        <div class="empty hidden" id="empty" role="status" aria-live="polite">No data for selected period.</div>
        <div class="error hidden" id="error" role="status" aria-live="polite">Error loading chart data.</div>
      </div>
    </section>

    <!-- NOVOS GRÁFICOS (apenas estes dois foram alterados) -->
    <section class="bottom">
      <div class="panel">
        <h3>Product Ranking – Top Sellers</h3>
        <p class="muted">Top products by quantity sold</p>
        <div id="productRankingChart" aria-label="Ranking de produtos mais vendidos" role="img" style="width:100%;height:100%;"></div>
      </div>
      <div class="panel">
  <h3>Product by collection and tags</h3>
  <p class="muted">Outer: collections • Inner: tags</p>
        <div class="collection-container">
          <div class="chart-container">
  <div id="collectionChart" aria-label="Produtos por coleção e tags" role="img"></div>
          </div>
          <div id="collectionLegend" class="legend-container"></div>
        </div>
      </div>
    </section>
  </div>

<script>
  /* ---------- SALES TREND (Shopify) ---------- */
  const ctx = document.getElementById('salesChart').getContext('2d');
  const isMobileQuery = window.matchMedia('(max-width: 767px)');
  const loadingEl = document.getElementById('loading');
  const emptyEl   = document.getElementById('empty');
  const errorEl   = document.getElementById('error');
  const subtitleEl= document.getElementById('subtitle');
  const pills = Array.from(document.querySelectorAll('#salesControls .pill'));
  const refreshBtn = document.getElementById('refreshBtn');

  const SALES_TREND_BASE = 'https://04-shopify-chart-sales-trend.lucas-def.workers.dev';

  function getSalesTrendUrl(days){
    switch(days){
      case 7:  return `${SALES_TREND_BASE}/salestrend7days`;
      case 30: return `${SALES_TREND_BASE}/salestrend30days`;
      case 90: return `${SALES_TREND_BASE}/salestrend90days`;
      default: return `${SALES_TREND_BASE}/salestrendany`;
    }
  }

  let currentDays = 30;
  let chart = null;

  function show(state){
    loadingEl.classList.toggle('hidden', state!=='loading');
    emptyEl.classList.toggle('hidden',   state!=='empty');
    errorEl.classList.toggle('hidden',   state!=='error');
  }

  async function fetchPoints(days){
    try{
      const url = getSalesTrendUrl(days);
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j = await res.json();
      // Shopify sales trend → usa "trend_data"
      if(j && Array.isArray(j.trend_data)) return j.trend_data;
      return [];
    }catch(e){
      console.warn('Sales trend error:', e);
      return null;
    }
  }

  function renderChart(points){
    if(chart) chart.destroy();

    const data = (points||[]).map(p=>({
      date: p.date,
      revenue: Number(
        p.total_sales ?? p.revenue ?? p.gross ?? p.total ?? p.amount ?? p.value ?? 0
      ) || 0
    }));

    const labels = data.map(d=>{
      const dt = new Date(d.date);
      if(Number.isNaN(dt.getTime())) return d.date;
      return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}`;
    });
    const values = data.map(d=>d.revenue);

    const tickSize = isMobileQuery.matches ? 10 : 12;
    const maxTicks = isMobileQuery.matches ? 6 : 12;
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Total Sales',
          data: values,
          borderColor: '#8B5CF6',
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 2.5,
          pointBackgroundColor: '#8B5CF6',
          fill: true,
          backgroundColor: (c)=>{
            const g = c.chart.ctx.createLinearGradient(0,0,0,300);
            g.addColorStop(0,'rgba(139,92,246,0.25)');
            g.addColorStop(1,'rgba(139,92,246,0)');
            return g;
          }
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display:false },
          tooltip: {
            backgroundColor:'#fff', titleColor:'#111827', bodyColor:'#111827',
            borderColor:'#e5e7eb', borderWidth:1, padding:10, displayColors:false,
            callbacks: {
              label: (ctx)=> ' '+Number(ctx.parsed.y).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}),
              title: (items)=> 'Date: '+items[0].label
            }
          }
        },
        scales: {
          x: {
            grid:{ display:false },
            ticks:{ color:'#6b7280', font:{ size: tickSize }, maxTicksLimit: maxTicks }
          },
          y: {
            grid:{ color:'#f0f0f0' },
            ticks:{
              color:'#6b7280', font:{ size: tickSize },
              callback:(v)=> Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
            }
          }
        }
      }
    });

    setTimeout(sendHeight, 50);
  }

  async function load(days){
    currentDays = days;
    pills.forEach(p=>p.classList.toggle('active', Number(p.dataset.days)===days));
    subtitleEl.textContent = `Sales evolution over the last ${days} days`;

    show('loading');
    const points = await fetchPoints(days);
    if(points === null){ show('error'); sendHeight(); return; }
    if(!points.length){ show('empty'); renderChart([]); return; }
    show('');
    renderChart(points);

    // KPIs agora puxam dos endpoints Shopify
    if(typeof loadKpis === 'function'){
      loadKpis(days);
    }
  }

  pills.forEach(p=>p.addEventListener('click', ()=>{
    const d = Number(p.dataset.days);
    load(d);
    loadTopSellers(d);
  }));
  refreshBtn.addEventListener('click', ()=>load(currentDays));

  /* ---------- AUTO HEIGHT (mesmo comportamento) ---------- */
  let __lastHeight = 0;
  let __heightTimer = null;
  function sendHeight(){
    if(__heightTimer) return; // throttle
    __heightTimer = setTimeout(()=>{
      __heightTimer = null;
      const h = Math.ceil(document.documentElement.scrollHeight);
      if(Math.abs(h - __lastHeight) > 2){
        __lastHeight = h;
        window.parent.postMessage({ iframeHeight: h }, '*');
      }
    }, 120);
  }
  window.addEventListener('load', sendHeight);
  window.addEventListener('resize', sendHeight);
  const mo = new MutationObserver(()=>sendHeight());
  mo.observe(document.body, { childList:true, subtree:true });

  /* ======================================================
     BOTTOM: TOP SELLERS + PRODUCTS BY COLLECTION
     Agora usando endpoints Shopify, mantendo layout
     ====================================================== */

  const TOP_SELLERS_BASE   = 'https://06-shopify-top-sellers.lucas-def.workers.dev';
  const COLLECTIONS_BASE   = 'https://05-shopify-products-by-collection.lucas-def.workers.dev';

  let productChart = null;
  let collectionChart = null;

  function getTopSellersUrl(days){
    switch(days){
      case 7:  return `${TOP_SELLERS_BASE}/topsellers7days`;
      case 30: return `${TOP_SELLERS_BASE}/topsellers`;       // assumindo range padrão = 30d
      case 90: return `${TOP_SELLERS_BASE}/topsellers90days`;
      default: return `${TOP_SELLERS_BASE}/topsellersany`;
    }
  }

  function renderTopSellers(labels, values){
    const el = document.getElementById('productRankingChart');
    if(productChart && productChart.dispose) productChart.dispose();
    productChart = echarts.init(el);
    const option = {
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' }
      },
      grid: { left: '3%', right: '4%', bottom: '12%', containLabel: true },
      xAxis: [{
        type: 'category',
        data: labels,
        axisTick: { alignWithLabel: true },
        axisLabel: {
          interval: 0,
          rotate: 28,
          color: '#9ca3af',
          // width + overflow help show full names by wrapping when long
          width: 160,
          overflow: 'break',
          formatter: function(value){ return String(value); }
        }
      }],
      yAxis: [{ type: 'value' }],
      series: [{
        name: 'Top Sellers',
        type: 'bar',
        barWidth: '60%',
        data: values,
        itemStyle: { color: '#8B5CF6' }
      }]
    };
    productChart.setOption(option);
    setTimeout(()=>{ if(productChart && productChart.resize) productChart.resize(); sendHeight(); }, 50);
  }

  async function loadTopSellers(days){
    try{
      const url = getTopSellersUrl(days||30);
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      const list = Array.isArray(json.top_sellers) ? json.top_sellers : [];
      if(!list.length){
        renderTopSellers(['No data'], [0]);
        return;
      }
      const labels = list.map(item=>item.product || item.name || 'Unnamed');
      const values = list.map(item=>Number(item.quantity ?? item.qty ?? 0) || 0);
      renderTopSellers(labels, values);
    }catch(e){
      console.warn('Top Sellers error:', e);
      renderTopSellers(['No data'], [0]);
    }
  }

  // Re-render Top Sellers on resize (throttled)
  let __topResizeTimer = null;
  window.addEventListener('resize', ()=>{
    if(__topResizeTimer) clearTimeout(__topResizeTimer);
    __topResizeTimer = setTimeout(()=>{
      if(productChart && productChart.resize) productChart.resize();
    }, 200);
  });

  /* ---------- PRODUCTS BY COLLECTION AND TAGS (dual pie ECharts) ---------- */
  let __collLabels = [];
  let __collValues = [];
  let __tagLabels = [];
  let __tagValues = [];

  function renderCollections(collLabels, collValues, tagLabels, tagValues){
    const el = document.getElementById('collectionChart');
    if(collectionChart && collectionChart.dispose) collectionChart.dispose();

    const palette = ['#8B5CF6','#22C55E','#F59E0B','#60A5FA','#F472B6','#14B8A6','#F97316','#3B82F6','#EF4444','#10B981'];
    const outerData = (collLabels||[]).map((name, i)=>({ name, value: Number((collValues||[])[i]||0) }));
    const innerData = (tagLabels||[]).map((name, i)=>({ name, value: Number((tagValues||[])[i]||0) }));

    const w = window.innerWidth;
    const isMobile = w <= 767;
    const isTablet = w >= 768 && w <= 1023;

    const legendData = Array.from(new Set([...(tagLabels||[]), ...(collLabels||[])]));
    const legendOpt = isMobile
      ? { type: 'scroll', orient: 'horizontal', bottom: 0, data: legendData }
      : { type: 'scroll', orient: 'vertical', right: 60, top: 20, bottom: 20, data: legendData };

    const center = isMobile ? ['50%', '46%'] : ['40%', '50%'];
    const innerRadiusMax = isMobile ? '28%' : (isTablet ? '28%' : '30%');
    const outerRadiusMin = isMobile ? '42%' : '45%';
    const outerRadiusMax = isMobile ? '58%' : (isTablet ? '58%' : '60%');

    collectionChart = echarts.init(el);
    const option = {
      color: palette,
      tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
      legend: legendOpt,
      series: [
        {
          name: 'Tags',
          type: 'pie',
          selectedMode: 'single',
          radius: [0, innerRadiusMax],
          center,
          label: { position: 'inner', fontSize: 12 },
          labelLine: { show: false },
          data: innerData
        },
        {
          name: 'Collections',
          type: 'pie',
          radius: [outerRadiusMin, outerRadiusMax],
          center,
          labelLine: { length: 30 },
          label: {
            formatter: '{a|{a}}{abg|}\n{hr|}\n  {b|{b}：}{c}  {per|{d}%}  ',
            backgroundColor: '#F6F8FC',
            borderColor: '#8C8D8E',
            borderWidth: 1,
            borderRadius: 4,
            rich: {
              a: { color: '#6E7079', lineHeight: 22, align: 'center' },
              hr: { borderColor: '#8C8D8E', width: '100%', borderWidth: 1, height: 0 },
              b: { color: '#4C5058', fontSize: 14, fontWeight: 'bold', lineHeight: 33 },
              per: { color: '#fff', backgroundColor: '#4C5058', padding: [3,4], borderRadius: 4 }
            }
          },
          data: outerData,
          emphasis: {
            itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0,0,0,0.3)' }
          }
        }
      ]
    };
    collectionChart.setOption(option);

    setTimeout(()=>{
      if(collectionChart && collectionChart.resize) collectionChart.resize();
      sendHeight();
    }, 50);
  }

  async function loadCollections(){
    try{
      const collUrl = `${COLLECTIONS_BASE}/productsbycollectionany`;
      const tagUrl  = `${COLLECTIONS_BASE}/productsbytagany`;
      const [collRes, tagRes] = await Promise.all([
        fetch(collUrl, { cache:'no-store' }),
        fetch(tagUrl,  { cache:'no-store' })
      ]);
      if(!collRes.ok) throw new Error('Collections HTTP '+collRes.status);
      if(!tagRes.ok)  throw new Error('Tags HTTP '+tagRes.status);
      const collJson = await collRes.json();
      const tagJson  = await tagRes.json();
      const collDist = Array.isArray(collJson.distribution) ? collJson.distribution : [];
      const tagDist  = Array.isArray(tagJson.distribution)  ? tagJson.distribution  : [];

      if(!collDist.length){
        __collLabels = ['No data'];
        __collValues = [1];
      }else{
        __collLabels = collDist.map(item=>item.collection || item.name || 'Uncategorized');
        __collValues = collDist.map(item=>Number(item.count ?? item.value ?? 0) || 0);
      }

      if(!tagDist.length){
        __tagLabels = ['No tags'];
        __tagValues = [1];
      }else{
        __tagLabels = tagDist.map(item=>item.tag || item.name || 'No Tags');
        __tagValues = tagDist.map(item=>Number(item.count ?? item.value ?? 0) || 0);
      }

      renderCollections(__collLabels, __collValues, __tagLabels, __tagValues);
    }catch(e){
      console.warn('Collections error:', e);
      __collLabels = ['No data'];
      __collValues = [1];
      __tagLabels = ['No tags'];
      __tagValues = [1];
      renderCollections(__collLabels, __collValues, __tagLabels, __tagValues);
    }
  }

  // Re-render pie quando a largura muda muito (breakpoints)
  let __collResizeTimer = null;
  window.addEventListener('resize', ()=>{
    if(__collResizeTimer) clearTimeout(__collResizeTimer);
    __collResizeTimer = setTimeout(()=>{ renderCollections(__collLabels, __collValues, __tagLabels, __tagValues); }, 200);
  });

  /* ---------- KPIs (usando workers Shopify) ---------- */
  const KPI_TOTAL_BASE  = 'https://01-shopify-sales-and-trands-kpi-total-sales.lucas-def.workers.dev';
  const KPI_AOV_BASE    = 'https://02-shopify-kpi-average-order-value.lucas-def.workers.dev';
  const KPI_TX_BASE     = 'https://03-shopify-kpi-number-of-transactions.lucas-def.workers.dev';
  const KPI_MARGIN_BASE = 'https://04-shopify-kpi-gross-margin.lucas-def.workers.dev';

  function getSalesKpiUrl(days){
    if(days === 7)  return `${KPI_TOTAL_BASE}/sales7days`;
    if(days === 90) return `${KPI_TOTAL_BASE}/sales90days`;
    if(days === 30) return `${KPI_TOTAL_BASE}/sales30days`;
    return `${KPI_TOTAL_BASE}/salesany`;
  }

  function getAovUrl(days){
    const d = (days === 7 || days === 30 || days === 90) ? String(days) : 'any';
    return `${KPI_AOV_BASE}/aov?days=${encodeURIComponent(d)}`;
  }

  function getTxUrl(days){
    if(days === 7)  return `${KPI_TX_BASE}/transactions7days`;
    if(days === 30) return `${KPI_TX_BASE}/transactions30days`;
    if(days === 90) return `${KPI_TX_BASE}/transactions90days`;
    return `${KPI_TX_BASE}/transactionsany`;
  }

  function getMarginUrl(days){
    if(days === 7)  return `${KPI_MARGIN_BASE}/grossmargin7days`;
    if(days === 30) return `${KPI_MARGIN_BASE}/grossmargin30days`;
    if(days === 90) return `${KPI_MARGIN_BASE}/grossmargin90days`;
    return `${KPI_MARGIN_BASE}/grossmarginany`;
  }

  function setKpiElements(kpis, days){
    const totalEl  = document.getElementById('kpi-total');
    const aovEl    = document.getElementById('kpi-aov');
    const txEl     = document.getElementById('kpi-transactions');
    const marginEl = document.getElementById('kpi-margin');

    // Aliases for new value IDs
    const totalAliasEl = document.getElementById('kpi-total-sales-value');
    const aovAliasEl   = document.getElementById('kpi-aov-value');
    const txAliasEl    = document.getElementById('kpi-tx-orders');
    const gmAliasEl    = document.getElementById('kpi-gm-value');

    const totalSubEl  = document.getElementById('kpi-total-sub');
    const aovSubEl    = document.getElementById('kpi-aov-sub');
    const txSubEl     = document.getElementById('kpi-transactions-sub');
    const marginSubEl = marginEl ? marginEl.parentElement.querySelector('.kpi-sub') : null;

    const rangeLabel = kpis.rangeLabel || (days ? `${days} days` : 'period');

    const totalSales = Number.isFinite(kpis.totalSales) ? kpis.totalSales : NaN;
    const aov        = Number.isFinite(kpis.aov)        ? kpis.aov        : NaN;
    const tx         = Number.isFinite(kpis.tx)         ? kpis.tx         : NaN;
    const margin     = kpis.margin ?? null;

    const currency = kpis.currency || 'USD';
    const formatter = (n)=>{
      if(!Number.isFinite(n)) return '—';
      try{ return new Intl.NumberFormat('en-US',{style:'currency',currency}).format(Number(n)); }
      catch(_){ return `$${Number(n).toFixed(2)}`; }
    };

    if(totalEl) totalEl.textContent = formatter(totalSales);
    if(aovEl)   aovEl.textContent   = formatter(aov);
    if(txEl)    txEl.textContent    = Number.isFinite(tx) ? tx : '—';
    if(marginEl){
      if(typeof margin === 'string')      marginEl.textContent = margin;
      else if(Number.isFinite(margin))    marginEl.textContent = `${Number(margin).toFixed(1)}%`;
      else                                marginEl.textContent = '—';
    }

    // Populate alias value elements if present
    if(totalAliasEl) totalAliasEl.textContent = formatter(totalSales);
    if(aovAliasEl)   aovAliasEl.textContent   = formatter(aov);
    if(txAliasEl)    txAliasEl.textContent    = Number.isFinite(tx) ? `${tx} Orders` : '—';
    if(gmAliasEl){
      if(typeof margin === 'string')      gmAliasEl.textContent = margin;
      else if(Number.isFinite(margin))    gmAliasEl.textContent = `${Number(margin).toFixed(1)}%`;
      else                                gmAliasEl.textContent = '—';
    }

    if(totalSubEl){
      const change = kpis.salesChange;
      if(change){ totalSubEl.textContent = `${change} vs previous period`; }
      else if(Number.isFinite(tx)) totalSubEl.textContent = `↑ ${tx} orders in last ${rangeLabel}`;
      else totalSubEl.textContent = `↑ Performance for last ${rangeLabel}`;
    }
    if(aovSubEl){
      const change = kpis.aovChange;
      if(change){ aovSubEl.textContent = `${change} vs previous period`; }
      else if(Number.isFinite(tx)) aovSubEl.textContent = `↑ Based on ${tx} transactions`;
      else aovSubEl.textContent = `↑ Average per order in last ${rangeLabel}`;
    }
    if(txSubEl){
      txSubEl.textContent = kpis.txMessage ? kpis.txMessage : `↑ Transactions in last ${rangeLabel}`;
    }
    if(marginSubEl){
      if(kpis.marginNote)      marginSubEl.textContent = kpis.marginNote;
      else if(kpis.marginChange) marginSubEl.textContent = `${kpis.marginChange} vs previous period`;
      else                     marginSubEl.textContent = 'Gross margin for last '+rangeLabel;
      marginSubEl.style.color = '#9ca3af';
    }
  }

  function deltaClass(changeStr, trend){
    if(trend === 'up') return 'delta-up';
    if(trend === 'down') return 'delta-down';
    if(typeof changeStr === 'string'){
      if(changeStr.trim().startsWith('+')) return 'delta-up';
      if(changeStr.trim().startsWith('-')) return 'delta-down';
    }
    return 'delta-flat';
  }

  function renderKpiDetails(kpis){
    const tsDetails = document.getElementById('kpi-total-sales-details');
    const aovDetails = document.getElementById('kpi-aov-details');
    const txDetails = document.getElementById('kpi-tx-details');
    const gmDetails = document.getElementById('kpi-gm-details');

    const currency = kpis.currency || 'USD';
    const fmt = (n)=>{
      if(n === null || n === undefined || n === '') return '—';
      const num = Number(n);
      if(!Number.isFinite(num)) return `$${n}`;
      try{ return new Intl.NumberFormat('en-US',{style:'currency',currency}).format(num); }
      catch(_){ return `$${num.toFixed(2)}`; }
    };

    // Helper for arrow by trend
    const arrow = (t)=> t==='up' ? '↑' : (t==='down' ? '↓' : '→');

    // Total Sales
    if(tsDetails){
      const cls = deltaClass(kpis.salesChange, kpis.salesTrend);
      tsDetails.innerHTML = `
        Prev: ${fmt(kpis.previousTotalSales)} <span class="${cls}">${kpis.salesChange || ''} ${arrow(kpis.salesTrend)}</span><br>
        Orders: ${Number.isFinite(kpis.salesOrders) ? kpis.salesOrders : '—'} · AOV: ${fmt(kpis.salesAov)}<br>
        Avg Weekly Growth: ${kpis.avgWeeklyGrowth || '—'}
      `;
    }

    // AOV
    if(aovDetails){
      const cls = deltaClass(kpis.aovChange, kpis.aovTrend);
      aovDetails.innerHTML = `
        Prev AOV: ${fmt(kpis.previousAov)} <span class="${cls}">${kpis.aovChange || ''} ${arrow(kpis.aovTrend)}</span><br>
        Orders: ${Number.isFinite(kpis.aovOrders) ? kpis.aovOrders : '—'} · Sales: ${fmt(kpis.aovSales)}
      `;
    }

    // Transactions
    if(txDetails){
      const cls = deltaClass(kpis.txChange, kpis.txTrend);
      txDetails.innerHTML = `
        Prev Orders: ${Number.isFinite(kpis.previousOrders) ? kpis.previousOrders : '—'} <span class="${cls}">${kpis.txChange || ''} ${arrow(kpis.txTrend)}</span><br>
        Total Sales: ${fmt(kpis.txSales)}<br>
        Period: ${kpis.txMessage || '—'}
      `;
    }

    // Gross Margin
    if(gmDetails){
      const cls = deltaClass(kpis.marginChange, kpis.marginTrend);
      gmDetails.innerHTML = `
        Profit: ${fmt(kpis.grossProfit)} · COGS: ${fmt(kpis.totalCogs)}<br>
        Prev Margin: ${kpis.previousMargin || '—'} <span class="${cls}">${kpis.marginChange || ''} ${arrow(kpis.marginTrend)}</span><br>
        ${kpis.marginNote || ''}
      `;
    }
  }

  async function loadKpis(days){
    try{
      const [salesRes, aovRes, txRes, marginRes] = await Promise.all([
        fetch(getSalesKpiUrl(days), { cache:'no-store' }),
        fetch(getAovUrl(days),      { cache:'no-store' }),
        fetch(getTxUrl(days),       { cache:'no-store' }),
        fetch(getMarginUrl(days),   { cache:'no-store' })
      ]);

      const salesJson  = salesRes.ok  ? await salesRes.json()  : null;
      const aovJson    = aovRes.ok    ? await aovRes.json()    : null;
      const txJson     = txRes.ok     ? await txRes.json()     : null;
      const marginJson = marginRes.ok ? await marginRes.json() : null;

      const kpis = {
        totalSales: salesJson
          ? Number(salesJson.total_sales ?? salesJson.totalSales ?? salesJson.total ?? NaN)
          : NaN,
        aov: aovJson
          ? Number(aovJson.average_order_value ?? aovJson.aov ?? NaN)
          : NaN,
        tx: txJson
          ? Number(txJson.total_orders ?? txJson.orders ?? txJson.totalOrders ?? NaN)
          : NaN,
        margin: marginJson
          ? (marginJson.gross_margin ?? marginJson.margin ?? null)
          : null,
        // Context & ranges
        currency:     salesJson?.currency || aovJson?.currency || txJson?.currency || marginJson?.currency || 'USD',
        rangeLabel:   salesJson?.range || aovJson?.range || txJson?.range || marginJson?.range || null,
        // Total Sales extras
        previousTotalSales: salesJson?.previous_total_sales || null,
        salesChange:        salesJson?.change_vs_previous || null,
        salesTrend:         salesJson?.trend || null,
        avgWeeklyGrowth:    salesJson?.avg_weekly_growth || null,
        salesOrders:        Number(salesJson?.total_orders ?? NaN),
        salesAov:           salesJson?.average_order_value || null,
        // AOV extras
        previousAov:        aovJson?.previous_aov || null,
        aovChange:          aovJson?.change_vs_previous || null,
        aovTrend:           aovJson?.trend || null,
        aovOrders:          Number(aovJson?.total_orders ?? NaN),
        aovSales:           aovJson?.total_sales || null,
        // Transactions extras
        txMessage:          txJson?.message || null,
        previousOrders:     Number(txJson?.previous_orders ?? NaN),
        txChange:           txJson?.change_vs_previous || null,
        txTrend:            txJson?.trend || null,
        txSales:            txJson?.total_sales || null,
        // Margin extras
        grossProfit:        marginJson?.gross_profit || null,
        totalCogs:          marginJson?.total_cogs || null,
        previousMargin:     marginJson?.previous_margin || null,
        marginChange:       marginJson?.change_vs_previous || null,
        marginTrend:        marginJson?.trend || null,
        marginNote:         marginJson?.note || null
      };

      setKpiElements(kpis, days);
      renderKpiDetails(kpis);
    }catch(e){
      console.warn('KPI load error:', e);
      setKpiElements({}, days);
      renderKpiDetails({});
    }
  }

  /* ---------- START DASHBOARD ---------- */
  function startDash(){
    loadKpis(30);
    load(30);
    const idle = window.requestIdleCallback || ((fn)=>setTimeout(fn, 500));
    idle(()=>{ loadTopSellers(currentDays); loadCollections(); });
  }
  function waitLibsAndStart(){
    if(window.Chart && window.echarts){ startDash(); }
    else { setTimeout(waitLibsAndStart, 60); }
  }
  window.addEventListener('load', waitLibsAndStart);
</script>




</body>
</html>
