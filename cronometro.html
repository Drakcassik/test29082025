<script>
  let startTime, elapsedTime = 0, timerInterval, isRunning = false;

  // Obtém taskId passado via query string: ?taskId=XXXX
  var urlParams = new URLSearchParams(window.location.search);
  var taskId = urlParams.get('taskId');

  if (!taskId) {
    console.error("Erro: taskId não fornecido na URL");
  }

  var API_URL = "https://x8ki-letl-twmt.n7.xano.io/api:MmzSqGu8/fluxo_de_trabalho/" + taskId;

  function formatTime(ms) {
    var total = Math.max(0, Math.floor(ms / 1000));
    var h = String(Math.floor(total / 3600)).padStart(2, '0');
    var m = String(Math.floor((total % 3600) / 60)).padStart(2, '0');
    var s = String(total % 60).padStart(2, '0');
    return h + ":" + m + ":" + s;
  }

  function updateDisplay() {
    var now = Date.now();
    var diff = now - startTime + elapsedTime;
    document.getElementById("timerText").textContent = formatTime(diff);
  }

  // Lê o estado atual no Xano (Tempo_Total, Timer_Running, Last_Started_At)
  async function fetchServerState() {
    try {
      var res = await fetch(API_URL, { method: "GET", cache: "no-store" });
      var data = await res.json();
      return {
        tempoTotalSec: Number(data && data.Tempo_Total ? data.Tempo_Total : 0),
        timerRunning: !!(data && data.Timer_Running),
        lastStartedAt: data && data.Last_Started_At ? data.Last_Started_At : null
      };
    } catch (e) {
      console.error("Erro ao buscar estado:", e);
      return { tempoTotalSec: 0, timerRunning: false, lastStartedAt: null };
    }
  }

  async function toggleTimer() {
    var btn = document.getElementById("toggleBtn");

    if (!taskId) {
      alert("taskId não encontrado na URL.");
      return;
    }

    if (!isRunning) {
      // ▶️ INICIAR / RETOMAR
      // 1) Antes de começar, sincroniza com o servidor
      var state = await fetchServerState();

      // base: tempo acumulado salvo
      elapsedTime = (isFinite(state.tempoTotalSec) ? state.tempoTotalSec : 0) * 1000;

      // se o servidor diz que estava rodando, soma o tempo desde o último start
      if (state.timerRunning && state.lastStartedAt) {
        var lastStartMs = Date.parse(state.lastStartedAt);
        if (!isNaN(lastStartMs)) {
          elapsedTime += (Date.now() - lastStartMs);
        }
      }

      // 2) Agora começa a sessão atual
      startTime = Date.now();
      timerInterval = setInterval(updateDisplay, 1000);
      isRunning = true;
      btn.textContent = "⏸️";

      // 3) Marca como rodando no servidor (reinicia o Last_Started_At)
      try {
        await fetch(API_URL, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Last_Started_At: new Date().toISOString(),
            Timer_Running: true
          })
        });
      } catch (e) {
        console.error("Erro ao iniciar timer:", e);
      }

    } else {
      // ⏸️ PAUSAR
      clearInterval(timerInterval);
      isRunning = false;
      btn.textContent = "▶️";

      var now = Date.now();
      var diff = now - startTime;
      elapsedTime += diff;

      var totalSeconds = Math.floor(elapsedTime / 1000);

      try {
        await fetch(API_URL, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Tempo_Total: totalSeconds,   // salva acumulado (s)
            Timer_Running: false
          })
        });
      } catch (e) {
        console.error("Erro ao pausar timer:", e);
      }

      document.getElementById("timerText").textContent = formatTime(elapsedTime);
    }
  }
</script>
