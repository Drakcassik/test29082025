<div style="display: flex; align-items: center; gap: 8px;">
  <button id="toggleBtn" onclick="toggleTimer()" style="background: none; border: none; font-size: 20px; cursor: pointer;">▶️</button>
  <span id="timerText" style="font-size: 14px; font-family: sans-serif;">00:00:00</span>
</div>

<script>
  let startTime = 0;          // timestamp (ms) quando começou a última sessão
  let elapsedTime = 0;        // ms acumulados (persistidos + sessão atual)
  let timerInterval = null;
  let isRunning = false;

  // --- Utilidades ---
  const $ = (id) => document.getElementById(id);
  const urlParams = new URLSearchParams(window.location.search);
  const taskId = urlParams.get('taskId');
  const API_URL = taskId
    ? `https://x8ki-letl-twmt.n7.xano.io/api:MmzSqGu8/fluxo_de_trabalho/${taskId}`
    : null;

  function formatTime(ms) {
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = String(Math.floor(total / 3600)).padStart(2, '0');
    const m = String(Math.floor((total % 3600) / 60)).padStart(2, '0');
    const s = String(total % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function paint(ms) {
    $("timerText").textContent = formatTime(ms);
  }

  function tick() {
    const now = Date.now();
    const diff = now - startTime; // ms desde que apertou play
    paint(elapsedTime + diff);
  }

  // --- Ciclo do botão ---
  async function toggleTimer() {
    if (!taskId || !API_URL) {
      alert("taskId não encontrado na URL.");
      return;
    }

    const btn = $("toggleBtn");

    if (!isRunning) {
      // ▶️ INICIAR / RETOMAR
      startTime = Date.now();
      timerInterval = setInterval(tick, 1000);
      isRunning = true;
      btn.textContent = "⏸️";

      try {
        await fetch(API_URL, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Last_Started_At: new Date().toISOString(),
            Timer_Running: true
          })
        });
      } catch (e) {
        console.error("Erro ao iniciar timer:", e);
      }

    } else {
      // ⏸️ PAUSAR
      clearInterval(timerInterval);
      isRunning = false;
      btn.textContent = "▶️";

      const now = Date.now();
      const sessionMs = now - startTime;
      elapsedTime += sessionMs; // acumula sessão atual

      paint(elapsedTime);

      try {
        await fetch(API_URL, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Tempo_Total: Math.floor(elapsedTime / 1000), // salva acumulado em segundos
            Timer_Running: false
          })
        });
      } catch (e) {
        console.error("Erro ao pausar timer:", e);
      }
    }
  }

  // --- Carregar estado salvo e auto-retomar se estiver rodando ---
  async function bootstrap() {
    if (!taskId || !API_URL) {
      console.error("taskId não fornecido na URL");
      paint(0);
      return;
    }

    try {
      const res = await fetch(API_URL, { method: "GET" });
      const data = await res.json();

      // Normaliza campos
      const persistedSeconds = Number(data?.Tempo_Total || 0);
      const wasRunning = Boolean(data?.Timer_Running);
      const lastStartedISO = data?.Last_Started_At;

      // Carrega acumulado persistido
      elapsedTime = persistedSeconds * 1000;
      paint(elapsedTime);

      // Se estava rodando, calcula o tempo que passou desde o último start e retoma
      if (wasRunning && lastStartedISO) {
        const lastStartMs = Date.parse(lastStartedISO); // ms
        if (!Number.isNaN(lastStartMs)) {
          startTime = Date.now();                       // novo marco
          // soma o tempo decorrido desde o último start ao elapsedTime,
          // mas sem persistir ainda (persistimos apenas ao pausar).
          const carryMs = Date.now() - lastStartMs;
          paint(elapsedTime + carryMs);

          timerInterval = setInterval(tick, 1000);
          isRunning = true;
          $("toggleBtn").textContent = "⏸️";
        } else {
          $("toggleBtn").textContent = "▶️";
        }
      } else {
        $("toggleBtn").textContent = "▶️";
      }
    } catch (err) {
      console.error("Erro ao carregar estado do timer:", err);
      paint(elapsedTime);
    }
  }

  window.addEventListener("load", bootstrap);
</script>
