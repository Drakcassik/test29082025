<div style="display: flex; align-items: center; gap: 8px;">
  <button id="toggleBtn" onclick="toggleTimer()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚ñ∂Ô∏è</button>
  <span id="timerText" style="font-size: 14px; font-family: sans-serif;">00:00:00</span>
</div>

<script>
  let startTime, elapsedTime = 0, timerInterval, isRunning = false;

  // Obt√©m taskId passado via query string: ?taskId=XXXX
  var urlParams = new URLSearchParams(window.location.search);
  var taskId = urlParams.get('taskId');

  if (!taskId) {
    console.error("Erro: taskId n√£o fornecido na URL");
  }

  var API_URL = "https://x8ki-letl-twmt.n7.xano.io/api:MmzSqGu8/fluxo_de_trabalho/" + taskId;

  function formatTime(ms) {
    var total = Math.max(0, Math.floor(ms / 1000));
    var h = String(Math.floor(total / 3600)).padStart(2, '0');
    var m = String(Math.floor((total % 3600) / 60)).padStart(2, '0');
    var s = String(total % 60).padStart(2, '0');
    return h + ":" + m + ":" + s;
  }

  function updateDisplay() {
    var now = Date.now();
    var diff = now - startTime + elapsedTime;
    document.getElementById("timerText").textContent = formatTime(diff);
  }

  async function toggleTimer() {
    var btn = document.getElementById("toggleBtn");

    if (!taskId) {
      alert("taskId n√£o encontrado na URL.");
      return;
    }

    if (!isRunning) {
      // ‚ñ∂Ô∏è INICIAR / RETOMAR
      startTime = Date.now();
      timerInterval = setInterval(updateDisplay, 1000);
      isRunning = true;
      btn.textContent = "‚è∏Ô∏è";

      try {
        await fetch(API_URL, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Last_Started_At: new Date().toISOString(),
            Timer_Running: true
          })
        });
      } catch (e) {
        console.error("Erro ao iniciar timer:", e);
      }

    } else {
      // ‚è∏Ô∏è PAUSAR
      clearInterval(timerInterval);
      isRunning = false;
      btn.textContent = "‚ñ∂Ô∏è";

      var now = Date.now();
      var diff = now - startTime;
      elapsedTime += diff;

      var totalSeconds = Math.floor(elapsedTime / 1000);

      try {
        await fetch(API_URL, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Tempo_Total: totalSeconds,   // salva acumulado (s)
            Timer_Running: false
          })
        });
      } catch (e) {
        console.error("Erro ao pausar timer:", e);
      }

      // pinta o acumulado final no display
      document.getElementById("timerText").textContent = formatTime(elapsedTime);
    }
  }

  // üëá ADI√á√ÉO 1: carregar tempo salvo e pintar
  async function bootstrap() {
    if (!taskId) return;

    try {
      var res = await fetch(API_URL, { method: "GET" });
      var data = await res.json();

      var persistedSeconds = Number(data && data.Tempo_Total ? data.Tempo_Total : 0);
      var wasRunning = !!(data && data.Timer_Running);
      var lastStartedISO = data && data.Last_Started_At ? data.Last_Started_At : null;

      // carrega acumulado salvo
      elapsedTime = persistedSeconds * 1000;
      document.getElementById("timerText").textContent = formatTime(elapsedTime);

      // üëá ADI√á√ÉO 2: se estava rodando, retoma automaticamente
      if (wasRunning && lastStartedISO) {
        var lastStartMs = Date.parse(lastStartedISO);
        if (!isNaN(lastStartMs)) {
          // calcula quanto passou desde o √∫ltimo start
          var carryMs = Date.now() - lastStartMs;

          // ajusta startTime para o intervalo come√ßar certo
          startTime = Date.now();
          // atualiza o display j√° considerando o carry
          document.getElementById("timerText").textContent = formatTime(elapsedTime + carryMs);

          // inicia o ticking
          timerInterval = setInterval(function() {
            var now = Date.now();
            var diff = now - startTime; // desde o bootstrap
            document.getElementById("timerText").textContent = formatTime(elapsedTime + carryMs + diff);
          }, 1000);

          isRunning = true;
          document.getElementById("toggleBtn").textContent = "‚è∏Ô∏è";
        }
      }
    } catch (err) {
      console.error("Erro ao carregar estado:", err);
      // mant√©m o display como est√° (00:00:00 ou o que j√° havia)
    }
  }

  // chama bootstrap ao carregar
  if (document.readyState === "complete" || document.readyState === "interactive") {
    // DOM j√° dispon√≠vel
    bootstrap();
  } else {
    window.addEventListener("load", bootstrap);
  }
</script>
